# BPMN

- Tạo sequence
CREATE SEQUENCE request_customer_seq
  START WITH 1
  INCREMENT BY 1
  NOCACHE
  NOCYCLE
  NOMAXVALUE;

  CREATE SEQUENCE SEQ_DATA_POOL_APPROVAL_PROCESS
  START WITH 1
  INCREMENT BY 1
  NOCACHE
  NOCYCLE
  NOMAXVALUE;

CREATE TABLE AlertHistory (
                            id NUMBER(19) PRIMARY KEY,
                            refId NUMBER(19),
                            refType VARCHAR2(50),
                            key VARCHAR2(100),
                            value VARCHAR2(255),
                            alertType VARCHAR2(50),
                            receiverEmail VARCHAR2(255),
                            agentId NUMBER(19),
                            alertSentDate TIMESTAMP,
                            status VARCHAR2(20),
                            note CLOB,
                            createdDate TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
                            modifiedDate TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
                            createdBy VARCHAR2(100),
                            modifiedBy VARCHAR2(100)
);

-- Tạo các index
CREATE INDEX idx_alert_refId_refType ON AlertHistory(refId, refType);
CREATE INDEX idx_alert_key_value ON AlertHistory(key, value);
CREATE INDEX idx_alert_alertType ON AlertHistory(alertType);
CREATE INDEX idx_alert_sentDate ON AlertHistory(alertSentDate);
CREATE INDEX idx_alert_agentId ON AlertHistory(agentId);
CREATE INDEX idx_alert_status ON AlertHistory(status);

======================= REMINDER ======================
create table DX_USER_TASK_REMINDER
(
  ID               NUMBER(19) not null
    primary key,
  REMINDERID       NUMBER(19),
  REFTYPE          VARCHAR2(255),
  REFID            VARCHAR2(255),
  REFERENCEURL     VARCHAR2(255),
  TITLE            VARCHAR2(255),
  DESCRIPTION      VARCHAR2(4000),
  STARTDATE        TIMESTAMP(6),
  DEADLINE         TIMESTAMP(6),
  PRIORITY         NUMBER(10),
  REMINDERSCHEDULE VARCHAR2(255),
  STATUS           NUMBER(10),
  USERID           NUMBER(19),
  CREATEDATE       TIMESTAMP(6),
  CREATEUSERID     NUMBER(19),
  MODIFIEDDATE     TIMESTAMP(6),
  MODIFIEDUSERID   NUMBER(19)
)

create table DX_USER_TASK
(
  ID             NUMBER(19) not null
    primary key,
  COMPANYID      NUMBER(19),
  REFTYPE        VARCHAR2(255),
  REFID          VARCHAR2(255),
  REFERENCEURL   VARCHAR2(255),
  TITLE          VARCHAR2(255),
  DESCRIPTION    VARCHAR2(4000),
  STARTDATE      TIMESTAMP(6),
  DEADLINE       TIMESTAMP(6),
  PRIORITY       NUMBER(10),
  REMINDSCHEDULE VARCHAR2(255),
  STATE          VARCHAR2(255),
  USERID         NUMBER(19),
  CREATEDATE     TIMESTAMP(6),
  CREATEUSERID   NUMBER(19),
  MODIFIEDDATE   TIMESTAMP(6),
  MODIFIEDUSERID NUMBER(19),
  REMINDMOBILE   NUMBER(1),
  REMINDWEB      NUMBER(1),
  REMINDMSEVENT  NUMBER(1),
  REMINDEMAIL    NUMBER(1)
)

CREATE SEQUENCE DX_USER_TASK_SEQ
    START WITH 1
    INCREMENT BY 1
    CACHE 100
    NOORDER
    NOCYCLE;

CREATE SEQUENCE DX_USER_TASK_REMINDER_SEQ
    START WITH 1
    INCREMENT BY 1
    MINVALUE 1
    NOMAXVALUE
    CACHE 1000
    NOORDER
    NOCYCLE;

======== BPMN ========

-- auto-generated definition
create table CUSTOMER_REQUEST
(
  REQUESTID         NUMBER(19) not null,
  USERNAME          VARCHAR2(100),
  ROOTID            NUMBER(19),
  BRANCHID          NUMBER(19),
  MERCHANTID        NUMBER(19),
  AGENTID           NUMBER(19),
  REQUESTTYPE       VARCHAR2(50),
  REQUESTGROUP      VARCHAR2(50),
  REQUESTNO         VARCHAR2(100),
  REQUESTDATE       DATE,
  TITLE             VARCHAR2(500),
  DESCRIPTION       CLOB,
  RESOLVEAGENTID    NUMBER(19),
  RESOLVEMERCHANTID NUMBER(19),
  RESOLVEBRANCHID   NUMBER(19),
  RESOLVETIME       DATE,
  RESOLVEDEADLINE   DATE,
  EXPECTEDTIME      DATE,
  FLOWTYPE          VARCHAR2(50),
  BPMNFLOWID        NUMBER(19),
  BPMNREQUESTID     NUMBER(19),
  LASTTASKIDS       VARCHAR2(500),
  STATE             VARCHAR2(50),
  CONTEXTSEARCH     CLOB,
  REFTYPE           VARCHAR2(50),
  REFID             NUMBER(19),
  SCHEDULEID        NUMBER(19),
  PRIORITY          VARCHAR2(20),
  STATUS            VARCHAR2(20),
  CREATEDATE        DATE default SYSDATE,
  CREATEUSERID      NUMBER(19),
  MODIFIEDDATE      DATE,
  MODIFIEDUSERID    NUMBER(19),
  USERID            NUMBER(19)
)

create index IDX_CR_REQUESTNO
  on CUSTOMER_REQUEST (REQUESTNO)

create index IDX_CR_REQUESTTYPE
  on CUSTOMER_REQUEST (REQUESTTYPE)

create index IDX_CR_REQUESTDATE
  on CUSTOMER_REQUEST (REQUESTDATE)

create index IDX_CR_STATUS
  on CUSTOMER_REQUEST (STATUS)

create index IDX_CR_STATE
  on CUSTOMER_REQUEST (STATE)

create index IDX_CR_AGENTID
  on CUSTOMER_REQUEST (AGENTID)

create index IDX_CR_MERCHANTID
  on CUSTOMER_REQUEST (MERCHANTID)

create index IDX_CR_BRANCHID
  on CUSTOMER_REQUEST (BRANCHID)

create index IDX_CR_SCHEDULEID
  on CUSTOMER_REQUEST (SCHEDULEID)

create index IDX_CR_BPMNREQUESTID
  on CUSTOMER_REQUEST (BPMNREQUESTID)

-- auto-generated definition
create table CUSTOMER_REQUEST_ACTION
(
  ACTIONID       NUMBER(19) not null,
  USERNAME       VARCHAR2(100),
  REQUESTID      NUMBER(19),
  AGENTID        NUMBER(19),
  MERCHANTID     NUMBER(19),
  BRANCHID       NUMBER(19),
  ACTION         VARCHAR2(100),
  TITLE          VARCHAR2(500),
  DESCRIPTION    CLOB,
  EXPECTEDTIME   DATE,
  CREATEDATE     DATE default SYSDATE,
  CREATEUSERID   NUMBER(19),
  MODIFIEDDATE   DATE,
  MODIFIEDUSERID NUMBER(19),
  USERID         NUMBER(19)
)

create index IDX_CRA_REQUESTID
  on CUSTOMER_REQUEST_ACTION (REQUESTID)

create index IDX_CRA_ACTION
  on CUSTOMER_REQUEST_ACTION (ACTION)

create index IDX_CRA_AGENTID
  on CUSTOMER_REQUEST_ACTION (AGENTID)

-- auto-generated definition
create table CUSTOMER_REQUEST_FLOW
(
  CONFIGID       NUMBER(19) not null,
  REQUESTTYPE    VARCHAR2(50),
  FLOWID         NUMBER(19),
  APPLYDATE      DATE,
  STATUS         NUMBER(1),
  CREATEDATE     DATE default SYSDATE,
  CREATEUSERID   NUMBER(19),
  MODIFIEDDATE   DATE,
  MODIFIEDUSERID NUMBER(19),
  USERID         NUMBER(19)
)

create index IDX_CRF_REQUESTTYPE
  on CUSTOMER_REQUEST_FLOW (REQUESTTYPE)

create index IDX_CRF_FLOWID
  on CUSTOMER_REQUEST_FLOW (FLOWID)

create index IDX_CRF_STATUS
  on CUSTOMER_REQUEST_FLOW (STATUS)

  -- auto-generated definition
create table CUSTOMER_REQUEST_SCHEDULE_LOG
(
  LOGID        NUMBER(19) not null,
  SCHEDULEID   NUMBER(19),
  REQUESTTIME  DATE,
  RESPONSETIME DATE,
  ERRORMESSAGE CLOB,
  STATUS       NUMBER(1)
)

create index IDX_CRSL_SCHEDULEID
  on CUSTOMER_REQUEST_SCHEDULE_LOG (SCHEDULEID)

create index IDX_CRSL_REQUESTTIME
  on CUSTOMER_REQUEST_SCHEDULE_LOG (REQUESTTIME)

create index IDX_CRSL_STATUS
  on CUSTOMER_REQUEST_SCHEDULE_LOG (STATUS)

  -- auto-generated definition
create table CRM_DATA_POOL_APPROVAL_PROCESS
(
  REQUESTID         NUMBER(19) not null,
  TYPE              VARCHAR2(50),
  NAMEREQUEST       VARCHAR2(500),
  STATUS            NUMBER(1),
  CUSTOMERREQUESTID NUMBER(19),
  DATAPOOLID        NUMBER(19),
  CONTRACTNO        VARCHAR2(100),
  ISCANCEL          NUMBER(1),
  CREATEDATE        DATE default SYSDATE,
  CREATEUSERID      NUMBER(19),
  MODIFIEDDATE      DATE,
  MODIFIEDUSERID    NUMBER(19),
  USERID            NUMBER(19),
  STEPRESULTSTATUS  NVARCHAR2(100),
  DESCREQUEST       VARCHAR2(4000)
)
/

  -- Sequence được sử dụng chung cho các bảng
CREATE SEQUENCE customer_request_seq
  START WITH 1
  INCREMENT BY 1
  CACHE 100
  NOCYCLE
  NOORDER;

CREATE SEQUENCE customer_request_action_seq
  START WITH 1
  INCREMENT BY 1
  CACHE 10
  NOCYCLE
  NOORDER;

CREATE SEQUENCE SEQ_DATA_POOL_APPROVAL_PROCESS
  START WITH 1
  INCREMENT BY 1
  CACHE 100
  NOCYCLE
  NOORDER;

CREATE SEQUENCE request_customer_seq
  START WITH 1
  INCREMENT BY 1
  CACHE 100
  NOCYCLE
  NOORDER;

<!-- Chuyển CLOB sang varchar2(4000) -->
ALTER TABLE CUSTOMER_REQUEST
  RENAME COLUMN CONTEXTSEARCH TO CONTEXTSEARCH_OLD;

ALTER TABLE CUSTOMER_REQUEST
  ADD CONTEXTSEARCH VARCHAR2(4000);

UPDATE CUSTOMER_REQUEST
SET CONTEXTSEARCH = SUBSTR(CONTEXTSEARCH_OLD, 1, 4000)
WHERE CONTEXTSEARCH_OLD IS NOT NULL;

COMMIT;

ALTER TABLE CUSTOMER_REQUEST
  DROP COLUMN CONTEXTSEARCH_OLD;

<!-- DESCRIPTION -->
ALTER TABLE CUSTOMER_REQUEST
  RENAME COLUMN DESCRIPTION TO DESCRIPTION_OLD;

ALTER TABLE CUSTOMER_REQUEST
  ADD DESCRIPTION VARCHAR2(4000);

UPDATE CUSTOMER_REQUEST
SET DESCRIPTION = SUBSTR(DESCRIPTION_OLD, 1, 4000)
WHERE DESCRIPTION_OLD IS NOT NULL;

COMMIT;

ALTER TABLE CUSTOMER_REQUEST
  DROP COLUMN DESCRIPTION_OLD;